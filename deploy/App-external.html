<!DOCTYPE html>
<html>
<head>
    <title>estimation-calibration</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.TimeboxScopedApp",scopeType:"release",getSettingsFields:function(){return[{name:"includeStories",xtype:"rallycheckboxfield",fieldLabel:"",boxLabel:"Include stories in calibration"},{name:"includeDefects",xtype:"rallycheckboxfield",fieldLabel:"",boxLabel:"Include defects in calibration"}]},config:{defaultSettings:{includeStories:!0,includeDefects:!1}},OUTLIER_THRESHOLD:1.5,app:null,filterContainer:null,contentContainer:null,scatterChart:null,boxPlotChart:null,launch:function(){app=this,filterContainer=app.down("container"),contentContainer=app.add({xype:"box",border:0}),app.callParent(arguments)},onScopeChange:function(scope){app.callParent(arguments),app.initializeFilters()},initializeFilters:function(){if(app.hideHeader(!1),filterContainer){var fromDateFieldId="fromDateFilter",toDateFieldId="toDateFilter",beginButtonId="beginButton",fromDateField=filterContainer.down("#"+fromDateFieldId),toDateField=filterContainer.down("#"+toDateFieldId),beginButton=filterContainer.down("#"+beginButtonId);toDateField||(filterContainer.add({xtype:"label",html:"--or--<br/>"}),fromDateField=filterContainer.add({xtype:"datefield",anchor:"100%",fieldLabel:"From",itemId:fromDateFieldId,name:"from_date"}),toDateField=filterContainer.add({xtype:"datefield",anchor:"100%",fieldLabel:"To",itemId:toDateFieldId,name:"to_date",vale:new Date}),filterContainer.add({xtype:"rallybutton",itemId:beginButtonId,text:"Begin!",handler:function(){app.beginButtonHandler(fromDateField,toDateField)},style:{"background-color":"#61257a","border-color":"#61257a"}}))}else{var scope=app.getContext().getTimeboxScope();if(scope){var record=scope.getRecord();app.fetchWorkItems(record.get("ReleaseStartDate"),record.get("ReleaseDate"))}else app.fetchWorkItems(null,null)}},beginButtonHandler:function(fromDateField,toDateField){app.clearContent(!1);var scope=app.getContext().getTimeboxScope(),fromDate=fromDateField.value;!fromDate&&scope&&(fromDate=scope.getRecord().get("ReleaseStartDate"));var toDate=toDateField.value;!toDate&&scope&&(toDate=scope.getRecord().get("ReleaseDate")),app.fetchWorkItems(fromDate,toDate)},fetchWorkItems:function(startDate,endDate){app._myMask=new Ext.LoadMask(Ext.getBody(),{msg:"Calculating... Please wait."}),app._myMask.show();var filters=[];if(startDate){var startDateFilter=Ext.create("Rally.data.wsapi.Filter",{property:"InProgressDate",operator:">=",value:startDate});filters.push(startDateFilter)}if(endDate){var endDateFilter=Ext.create("Rally.data.wsapi.Filter",{property:"AcceptedDate",operator:"<=",value:endDate});filters.push(endDateFilter)}var estimateFilter=Ext.create("Rally.data.wsapi.Filter",{property:"PlanEstimate",operator:">",value:"0"});filters.push(estimateFilter);var estimateTimes={};this.getSetting("includeStories")?app.fetchCycleTimes(filters,"UserStory",estimateTimes):this.getSetting("includeDefects")?app.fetchCycleTimes(filters,"Defect",estimateTimes):app.showMessage("Please use the app's settings to display at least stories or defects.")},fetchCycleTimes:function(filters,model,estimateTimes){var store=Ext.create("Rally.data.wsapi.Store",{model:model,fetch:["FormattedID","Name","InProgressDate","AcceptedDate","PlanEstimate"],context:app.getContext().getDataContext(),pageSize:2e3,limit:2e3,sorters:[{property:"PlanEstimate",direction:"ASC"}]},app);store.addFilter(filters,!1),store.loadPage(1,{scope:app,callback:function(records,operation){operation.wasSuccessful()&&(_.each(records,function(record){null!==record.data.InProgressDate&&null!==record.data.AcceptedDate&&(estimateEntry={},estimateEntry.estimate=Number(record.data.PlanEstimate),estimateEntry.id=record.data.FormattedID,estimateEntry.name=record.data.Name,estimateEntry.ref=record.data._ref,estimateEntry.cycleTime=app.countWeekDays(new Date(record.data.InProgressDate),new Date(record.data.AcceptedDate)),estimateEntry.cycleTime>.25&&(_.contains(Object.keys(estimateTimes),estimateEntry.estimate.toString())||(estimateTimes[estimateEntry.estimate]=[]),estimateTimes[estimateEntry.estimate].push(estimateEntry)))},app),"UserStory"==model&&this.getSetting("includeDefects")?app.fetchCycleTimes(filters,"Defect",estimateTimes):app.prepareScatterChart(estimateTimes))}})},prepareScatterChart:function(estimateTimes){if(Object.keys(estimateTimes).length>0){var seriesData=[];seriesData.push({}),seriesData[0].name="Work Items",seriesData[0].data=[],_.each(estimateTimes,function(estimateLookup){_.each(estimateLookup,function(story){var point={};point.x=story.estimate,point.y=story.cycleTime,point.tooltip=story.id+" - "+story.name+"<br/>Cycle Time: "+story.cycleTime+"d",point.name=story.name,point.id=story.id,point.ref=story.ref,seriesData[0].data.push(point)},app)},app),app.drawScatterChart(seriesData,estimateTimes)}else app.showMessage("There is no data. There needs to be work items with PlanEstimate which were marked in-progress and accepted within the timebox. You can use the app's settings to display stories and/or defects.")},drawScatterChart:function(seriesData,estimateTimes){scatterChart=contentContainer.add({xtype:"rallychart",storeConfig:{},chartConfig:{chart:{type:"scatter",zoomType:"xy"},legend:{enabled:!0},xAxis:{title:{text:"Plan Estimate"},tickInterval:null,startOnTick:!0,endOnTick:!0,showLastLabel:!0,min:0},yAxis:{title:{text:"Cycle Time (workdays)"},tickInterval:null,min:0,gridLineWidth:0},title:{text:""},tooltip:{useHTML:!0,pointFormat:"{point.tooltip}",headerFormat:""}},chartData:{series:seriesData}});var colors=["#61257a"];scatterChart.setChartColors(colors),contentContainer.add({xtype:"label",html:"This graph shows your completed work items' cycle times by estimate.*<br/>Click below to see how you can improve your estimates to be more consistent and predictable.<br/><br/>",style:{"font-size":"15px"}}),contentContainer.add({xtype:"rallybutton",text:"Calibrate Estimates",id:"calibrationbutton",handler:function(){app.onCalibrateButton(estimateTimes)},style:{"background-color":"#61257a","border-color":"#61257a"}}),contentContainer.add({xtype:"label",html:'<a href="https://help.rallydev.com/sizing-and-estimates-overview">Learn about agile estimation</a>',style:{"font-size":"15px"}}),contentContainer.add({xtype:"label",html:"<br/><br/>* Only work items marked in-progress and accepted in this timebox are tracked. Work Items with no estimate, an estimate of 0, or a cycle time of 0.25 days or less are ignored. Use the app's setting to choose whether you want to calibrate stories, defects, or both.",style:{"font-size":"9px"}}),this._myMask.hide()},onCalibrateButton:function(estimateTimes){var boxplots=[],outliers=[],sortedKeys=_.keys(estimateTimes).map(Number).sort(function(a,b){return a-b});_.each(sortedKeys,function(key){var values=estimateTimes[key].sort(function(a,b){return a.cycleTime-b.cycleTime}),Q1=0,Q2=0,Q3=0,q1Arr=[],q2Arr=[],q3Arr=[];1==values.length?q1Arr=q2Arr=q3Arr=values:(q1Arr=values.length%2===0?values.slice(0,values.length/2):values.slice(0,Math.floor(values.length/2)),q2Arr=values,q3Arr=values.length%2===0?values.slice(values.length/2,values.length):values.slice(Math.ceil(values.length/2),values.length)),Q1=app.medianX(q1Arr),Q2=app.medianX(q2Arr),Q3=app.medianX(q3Arr);for(var interquartile_range=Q3-Q1,min_index=0;values[min_index].cycleTime<Q1-app.OUTLIER_THRESHOLD*interquartile_range;)outliers.push([boxplots.length,values[min_index].cycleTime]),min_index++;for(var max_index=values.length-1;values[max_index].cycleTime>Q3+app.OUTLIER_THRESHOLD*interquartile_range;)outliers.push([boxplots.length,values[max_index].cycleTime]),max_index--;var boxplotPoint={};boxplotPoint.x=boxplots.length,boxplotPoint.low=values[min_index].cycleTime,boxplotPoint.q1=Q1,boxplotPoint.median=Q2,boxplotPoint.q3=Q3,boxplotPoint.high=values[max_index].cycleTime,boxplotPoint.count=max_index-min_index+1,boxplotPoint.estimate=values[0].estimate,boxplots.push(boxplotPoint),values.unshift(boxplotPoint)},app),app.hideHeader(!0),app.clearContent(!1),boxPlotChart=contentContainer.add({xtype:"rallychart",storeConfig:{},chartConfig:{chart:{type:"boxplot"},title:{text:""},xAxis:{title:{text:"Plan Estimate (Points)"}},yAxis:{title:{text:"Cycle Time (workdays)"},allowDecimals:!1,min:0,gridLineWidth:0},plotOptions:{column:{pointPadding:.2,borderWidth:0}}},chartData:{series:[{name:"Cycle Time",data:boxplots,tooltip:{headerFormat:"<b>Estimate:</b> {point.x}<br/>",pointFormat:"<b>Maximum:</b> {point.high}<br/><b>Upper quartile:</b> {point.q3}<br/><b>Median:</b> {point.median}<br/><b>Lower quartile:</b> {point.q1}<br/><b>Minimum:</b> {point.low}<br/><b>Count:</b> {point.count}"}},{name:"Outliers",type:"scatter",data:outliers,tooltip:{pointFormat:"{point.y}"},marker:{symbol:"circle"}}],categories:sortedKeys}});var colors=["#61257a","#61257a"];boxPlotChart.setChartColors(colors),contentContainer.add({xtype:"label",html:"Your data, displayed as a box plot, will help us identify which stories could benefit most from further analysis.<br/>First, let's find where you are already being consistent. We will use this as an anchor estimate to then form a basis for your other relative estimates.<br/><br/>",style:{"font-size":"15px"}}),contentContainer.add({xtype:"rallybutton",text:"Identify Anchor Estimate",handler:function(){app.onIdentifyAnchorButton(estimateTimes)},style:{"background-color":"#61257a","border-color":"#61257a"}}),contentContainer.add({xtype:"label",html:'<a href="https://www.khanacademy.org/math/probability/data-distributions-a1/box--whisker-plots-a1/v/reading-box-and-whisker-plots">Learn how to read box plots</a>',style:{"font-size":"15px"}})},onIdentifyAnchorButton:function(estimateTimes){var bestScore=0,bestEstimate,bestX,bestMedianCycleTime;_.each(estimateTimes,function(values){boxplotSummary=values[0];var score=boxplotSummary.count/(boxplotSummary.q3-boxplotSummary.q1);score!=1/0&&score>bestScore&&(bestScore=score,bestX=boxplotSummary.x,bestEstimate=boxplotSummary.estimate,bestMedianCycleTime=boxplotSummary.median)});var chartData=boxPlotChart.getChartData(),chartConfig=boxPlotChart.getChartConfig();chartData.series[0].data[bestX].color="#d30606",boxPlotChart.refresh({chartData:chartData}),app.clearContent(!0),contentContainer.add({xtype:"label",html:"Stories with an estimate of "+bestEstimate+" had the best balance of a tight interquartile range and a large number of stories. Let's use this to set ideal relative cycle times for our estimates.<br/><br/>",style:{"font-size":"15px"}}),contentContainer.add({xtype:"rallybutton",text:"Project Ideal Cycle Times",handler:function(){app.onProjectIdealCycleTimesButton(bestEstimate,bestMedianCycleTime)},style:{"background-color":"#61257a","border-color":"#61257a"}})},onProjectIdealCycleTimesButton:function(bestEstimate,bestMedianCycleTime){var chartData=boxPlotChart.getChartData(),estimateIdeals={},greyColor=9,boxplotData=chartData.series[0].data.slice(0).reverse();_.each(boxplotData,function(boxplot){var diff=boxplot.estimate/bestEstimate,ideal=bestMedianCycleTime*diff;estimateIdeals[boxplot.estimate]=ideal;var newSeries={};newSeries.type="line",newSeries.name="Ideal Cycle Time for "+boxplot.estimate+"s",newSeries.lineWidth=2,newSeries.marker={},newSeries.marker.enabled=!1,newSeries.dashStyle="dash",newSeries.color="#"+Array(7).join(parseInt(greyColor,10).toString()),greyColor-=9/boxplotData.length;var dataArray=[];for(i=0;i<boxplotData.length;i++)dataArray.push({x:i,y:ideal});newSeries.data=dataArray,chartData.series.unshift(newSeries)}),boxPlotChart.refresh({chartData:chartData}),app.clearContent(!0),contentContainer.add({xtype:"label",html:"Taking these ideal cycle times, let's apply them back to our individual work item cycle times to see if there are ways to better estimate your work.<br/><br/>",style:{"font-size":"15px"}}),contentContainer.add({xtype:"rallybutton",text:"Identify Opportunities for Improvement",handler:function(){app.onIdentifyImprovements(estimateIdeals)},style:{"background-color":"#61257a","border-color":"#61257a"}})},onIdentifyImprovements:function(estimateIdeals){app.clearContent(!1);var minEstimateSeriesData=[],maxEstimateSeriesData=[],sortedKeys=_.keys(estimateIdeals).map(Number).sort(function(a,b){return a-b});sortedKeys.forEach(function(estimate,index){var prevDiff=null;if(0!==minEstimateSeriesData.length){var priorEstimate=sortedKeys[index-1];prevDiff=(estimateIdeals[estimate]-estimateIdeals[priorEstimate])*(priorEstimate/estimate)}var nextDiff=null;if(maxEstimateSeriesData.length!=estimateIdeals.length-1){var nextEstimate=sortedKeys[index+1];nextDiff=(estimateIdeals[nextEstimate]-estimateIdeals[estimate])*(1-estimate/nextEstimate)}prevDiff||nextDiff?prevDiff?nextDiff||(nextDiff=prevDiff):prevDiff=nextDiff:prevDiff=nextDiff=0;var minIdealCycleTime=estimateIdeals[estimate]-prevDiff;minEstimateSeriesData.push({x:parseInt(estimate,10),y:minIdealCycleTime,tooltip:"Minimum Ideal Cycle Time: "+minIdealCycleTime});var maxIdealCycleTime=estimateIdeals[estimate]+nextDiff;maxEstimateSeriesData.push({x:parseInt(estimate,10),y:maxIdealCycleTime,tooltip:"Maximum Ideal Cycle Time: "+maxIdealCycleTime})});var minCycleTimes={type:"line",name:"Min Ideal Cycle Times",data:minEstimateSeriesData,lineWidth:2,marker:{enabled:!1},color:"#ad3408"},maxCycleTimes={type:"line",name:"Max Ideal Cycle Times",data:maxEstimateSeriesData,lineWidth:2,marker:{enabled:!1},color:"#ad3408"};chartData=scatterChart.getChartData(),_.each(chartData.series[0].data,function(scatterPoint){var ideal,maxEstimateSeriesIndex=_.findKey(maxEstimateSeriesData,function(v){return v.y>scatterPoint.y});if(ideal=void 0!==maxEstimateSeriesIndex?maxEstimateSeriesData[maxEstimateSeriesIndex].x:void 0,void 0===ideal)scatterPoint.issueScore=1e3-scatterPoint.x,scatterPoint.issueScore+=scatterPoint.y/1e3;else{scatterPoint.issueScore=Math.abs(scatterPoint.x-ideal);var cycleTimeScore=Math.abs(maxEstimateSeriesData[maxEstimateSeriesIndex].y-scatterPoint.y)/1e3;scatterPoint.x-ideal>=0?scatterPoint.issueScore+=cycleTimeScore:scatterPoint.issueScore-=cycleTimeScore}scatterPoint.tooltip+="<br/>Estimate: "+scatterPoint.x+"<br/>Ideal Estimate: ",void 0!==ideal?scatterPoint.tooltip+=ideal:scatterPoint.tooltip+=">"+maxEstimateSeriesData[maxEstimateSeriesData.length-1].x,scatterPoint.ideal=ideal,scatterPoint.x!=ideal?scatterPoint.color="#61257a":scatterPoint.color="#d30606"}),chartData.series[0].marker={},chartData.series[0].marker.symbol="circle";var rankedIssues=_.sortBy(chartData.series[0].data,function(point){return point.issueScore});rankedIssues.reverse();var worstIssues=[];for(i=0;i<5;i++){var tooltipMatch=rankedIssues[i].tooltip;for(j=0;j<chartData.series[0].data.length;j++)if(scatterPoint=chartData.series[0].data[j],scatterPoint.tooltip==tooltipMatch){scatterPoint.marker={},scatterPoint.marker.symbol="diamond",scatterPoint.color="#3300ff";var idealString;idealString=void 0!==scatterPoint.ideal?scatterPoint.ideal.toString():">"+maxEstimateSeriesData[maxEstimateSeriesData.length-1].x,worstIssues.push([scatterPoint.id,scatterPoint.name,scatterPoint.y,scatterPoint.x,idealString])}}var worstIssuesStore=Ext.create("Ext.data.ArrayStore",{storeId:"worstIssues",fields:[{name:"formattedId",type:"string"},{name:"name",type:"string"},{name:"cycleTime",type:"float"},{name:"estimate",type:"integer"},{name:"idealEstimate",type:"string"}],data:worstIssues});chartData.series.unshift(maxCycleTimes),chartData.series.unshift(minCycleTimes),contentContainer.add(Ext.merge(scatterChart.initialConfig,chartData)),contentContainer.add({xtype:"label",html:"On the scatter plot of cycle times by estimate, we now have lines to note the minimum and maximum cycle times for each estimate. The work items that need the most readjustment have been marked in blue diamonds, and listed below:<br/><br/>",style:{"font-size":"15px"}}),contentContainer.add({xtype:"rallygrid",showPagingToolbar:!1,showRowActionsColumn:!1,editable:!1,store:worstIssuesStore,columnCfgs:[{text:"ID",dataIndex:"formattedId",flex:!0},{text:"Name",dataIndex:"name",flex:!0},{text:"Cycle Time",dataIndex:"cycleTime",flex:!0},{text:"Estimate",dataIndex:"estimate",flex:!0},{text:"Ideal Estimate",dataIndex:"idealEstimate",flex:!0}]}),contentContainer.add({xtype:"label",html:"<br/>",style:{"font-size":"15px"}}),contentContainer.add({xtype:"rallybutton",text:"Brainstorm Actions to Realign Estimates",handler:function(){app.onBrainstormActions()},style:{"background-color":"#61257a","border-color":"#61257a"}})},onBrainstormActions:function(){app.clearContent(!1),contentContainer.add({xtype:"label",html:"What actions could you take to better estimate work items like these? Some questions to spark discussion:<br/><ul><li>What, had you known it sooner, would have changed your estimate? How could you have known sooner?</li><li>Could this work have been broken down into smaller work items?</li><li>What risks manifested during this work? Could they have been avoided or mitigated?</li><li>Did emergency work cause you to put this work on hold? If so, was it the right decision to change priorities?</li><li>Are there patterns or similarities to this work that you could watch for in future estimations?</li></ul>Please enter actions you could take to better estimate work items like these in the future.<br/><br/>NOTE: These actions are not currently saved, so make a copy for later if you'd like.",style:{"font-size":"15px"}}),contentContainer.add({xtype:"textareafield",grow:!0,name:"actionItems",anchor:"100%",width:"100%"}),contentContainer.add({xtype:"label",html:"<br/>Congrats in advance for committing to these action items and making your estimates more consistent and predictable. Hopefully you'll check back after they're implemented to see how your cycle times have changed and identify your next actions for continual improvement.",style:{"font-size":"15px"}})},showMessage:function(text){app._myMask.hide(),contentContainer.add({xtype:"label",text:text})},medianX:function(medianArr){return count=medianArr.length,median=count%2===0?(medianArr[medianArr.length/2-1].cycleTime+medianArr[medianArr.length/2].cycleTime)/2:medianArr[Math.floor(medianArr.length/2)].cycleTime,median},countWeekDays:function(dDate1,dDate2){for(var days=0,dateItr=dDate1;dateItr<dDate2;)dateItr.setHours(dateItr.getHours()+6),6!=dateItr.getDay()&&0!==dateItr.getDay()&&(days+=.25);return days},hideHeader:function(hiddenValue){filterContainer&&filterContainer.setVisible(!hiddenValue)},clearContent:function(keepCharts){for(;contentContainer.down("label");)contentContainer.down("label").destroy();for(;contentContainer.down("button");)contentContainer.down("button").destroy();if(!keepCharts)for(;contentContainer.down("rallychart");)contentContainer.down("rallychart").destroy()}});

            Rally.launchApp('CustomApp', {
                name:"estimation-calibration",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
