<!DOCTYPE html>
<html>
<head>
    <title>estimation-calibration</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.TimeboxScopedApp",scopeType:"release",filters:[],pagesize:2e3,estimate_times:{},launch:function(){console.log("Launching..."),this.fetchWorkItems(this.getContext().getTimeboxScope())},onTimeboxScopeChange:function(newTimeboxScope){console.log("Timebox Scope Changed..."),this.callParent(arguments),this.fetchWorkItems(newTimeboxScope)},fetchWorkItems:function(timeboxScope){console.log("Fetching Work Items..."),this._myMask=new Ext.LoadMask(Ext.getBody(),{msg:"Calculating...Please wait."}),this._myMask.show(),this.filters=[];var startDate=timeboxScope.record.raw.ReleaseStartDate,endDate=timeboxScope.record.raw.ReleaseDate,startDateFilter=Ext.create("Rally.data.wsapi.Filter",{property:"AcceptedDate",operator:">=",value:startDate}),endDateFilter=Ext.create("Rally.data.wsapi.Filter",{property:"AcceptedDate",operator:"<=",value:endDate});this.filters.push(startDateFilter),this.filters.push(endDateFilter);var dataScope=this.getContext().getDataContext(),store=Ext.create("Rally.data.wsapi.Store",{model:"UserStory",fetch:["InProgressDate","AcceptedDate","PlanEstimate"],context:dataScope,pageSize:this.pagesize,limit:this.pagesize,sorters:[{property:"PlanEstimate",direction:"ASC"}]},this);store.addFilter(this.filters,!1),store.loadPage(1,{scope:this,callback:function(records,operation){operation.wasSuccessful()&&(console.log("Sorting Cycle Times by Estimate..."),_.each(records,function(record){if(null!==record.data.InProgressDate&&null!==record.data.AcceptedDate){var estimate=record.data.PlanEstimate,cycle_time=(record.data.AcceptedDate-record.data.InProgressDate)/864e5;_.contains(Object.keys(this.estimate_times),""+estimate)||(this.estimate_times[estimate]=[]),this.estimate_times[estimate].push(cycle_time)}},this),this.prepareChart())}})},prepareChart:function(){if(Object.keys(this.estimate_times).length>0){console.log("Making the chart...");var categories=Object.keys(this.estimate_times),series=[];_.each(this.estimate_times,function(values){values=values.sort(function(a,b){return a-b});var Q1=0,Q2=0,Q3=0,q1Arr=[],q2Arr=[],q3Arr=[];1==values.length?q1Arr=q2Arr=q3Arr=values:(q1Arr=0===values.length%2?values.slice(0,values.length/2):values.slice(0,Math.floor(values.length/2)),q2Arr=values,q3Arr=0===values.length%2?values.slice(values.length/2,values.length):values.slice(Math.ceil(values.length/2),values.length)),Q1=this.medianX(q1Arr),Q2=this.medianX(q2Arr),Q3=this.medianX(q3Arr),series.push([values[0],Q1,Q2,Q3,values[values.length-1]])},this),this.makeChart(series,categories)}else this.showNoDataBox()},makeChart:function(series_data,categories_data){this._myMask.hide();var chart=this.add({xtype:"rallychart",chartConfig:{chart:{type:"boxplot"},title:{text:"Cycle Times by Estimation"},xAxis:{title:{text:"Estimations"}},yAxis:{title:{text:"Cycle Times"},allowDecimals:!1,min:0},plotOptions:{column:{pointPadding:.2,borderWidth:0}}},chartData:{series:[{name:"Cycle Times",data:series_data}],categories:categories_data}})},showNoDataBox:function(){this._myMask.hide(),Ext.ComponentQuery.query("container[itemId=stats]")[0].update("There is no data. </br>Check if there are interations in scope and work items with PlanEstimate assigned for iterations")},medianX:function(medianArr){return count=medianArr.length,median=0===count%2?(medianArr[medianArr.length/2-1]+medianArr[medianArr.length/2])/2:medianArr[Math.floor(medianArr.length/2)]}});

            Rally.launchApp('CustomApp', {
                name:"estimation-calibration",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
