<!DOCTYPE html>
<html>
<head>
    <title>estimation-calibration</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.TimeboxScopedApp",scopeType:"release",filters:[],pagesize:2e3,estimateTimes:{},OUTLIER_THRESHOLD:1.5,onScopeChange:function(scope){this.callParent(arguments),this.fetchWorkItems(scope)},fetchWorkItems:function(scope){this._myMask=new Ext.LoadMask(Ext.getBody(),{msg:"Calculating...Please wait."}),this._myMask.show(),this.down("rallychart")&&this.down("rallychart").destroy(),this.down("label")&&this.down("label").destroy(),this.filters=[],this.estimateTimes={},this.filters=[];var startDate=scope.record.raw.ReleaseStartDate,endDate=scope.record.raw.ReleaseDate,startDateFilter=Ext.create("Rally.data.wsapi.Filter",{property:"InProgressDate",operator:">=",value:startDate}),endDateFilter=Ext.create("Rally.data.wsapi.Filter",{property:"AcceptedDate",operator:"<=",value:endDate}),estimateFilter=Ext.create("Rally.data.wsapi.Filter",{property:"PlanEstimate",operator:"!=",value:"null"});this.filters.push(startDateFilter),this.filters.push(endDateFilter),this.filters.push(estimateFilter);var dataScope=this.getContext().getDataContext(),store=Ext.create("Rally.data.wsapi.Store",{model:"UserStory",fetch:["InProgressDate","AcceptedDate","PlanEstimate"],context:dataScope,pageSize:this.pagesize,limit:this.pagesize,sorters:[{property:"PlanEstimate",direction:"ASC"}]},this);store.addFilter(this.filters,!1),store.loadPage(1,{scope:this,callback:function(records,operation){operation.wasSuccessful()&&(_.each(records,function(record){if(null!==record.data.InProgressDate&&null!==record.data.AcceptedDate){var estimate=record.data.PlanEstimate,cycleTime=this.countWeekDays(new Date(record.data.InProgressDate),new Date(record.data.AcceptedDate));_.contains(Object.keys(this.estimateTimes),""+estimate)||(this.estimateTimes[estimate]=[]),this.estimateTimes[estimate].push(cycleTime)}},this),this.prepareChart())}})},prepareChart:function(){if(Object.keys(this.estimateTimes).length>0){var categories=Object.keys(this.estimateTimes),boxplots=[],outliers=[];_.each(this.estimateTimes,function(values){values=values.sort(function(a,b){return a-b});var Q1=0,Q2=0,Q3=0,q1Arr=[],q2Arr=[],q3Arr=[];1==values.length?q1Arr=q2Arr=q3Arr=values:(q1Arr=0===values.length%2?values.slice(0,values.length/2):values.slice(0,Math.floor(values.length/2)),q2Arr=values,q3Arr=0===values.length%2?values.slice(values.length/2,values.length):values.slice(Math.ceil(values.length/2),values.length)),Q1=this.medianX(q1Arr),Q2=this.medianX(q2Arr),Q3=this.medianX(q3Arr);for(var interquartile_range=Q3-Q1,min_index=0;values[min_index]<Q1-this.OUTLIER_THRESHOLD*interquartile_range;)outliers.push([boxplots.length,values[min_index]]),min_index++;for(var max_index=values.length-1;values[max_index]>Q3+this.OUTLIER_THRESHOLD*interquartile_range;)outliers.push([boxplots.length,values[max_index]]),max_index--;boxplots.push([values[min_index],Q1,Q2,Q3,values[max_index]])},this),this.makeChart(boxplots,outliers,categories)}else this.showNoDataBox()},makeChart:function(boxplots,outliers,categoriesData){this._myMask.hide(),this.down("rallychart")&&this.down("rallychart").destroy();var chart=this.add({xtype:"rallychart",chartConfig:{chart:{type:"boxplot"},title:{text:"Cycle Time by Plan Estimate"},xAxis:{title:{text:"Plan Estimate (Points)"}},yAxis:{title:{text:"Cycle Time (Days)"},allowDecimals:!1,min:0},plotOptions:{column:{pointPadding:.2,borderWidth:0}}},chartData:{series:[{name:"Cycle Time (Days)",data:boxplots},{name:"Outliers (Days)",type:"scatter",data:outliers,tooltip:{pointFormat:"{point.y}"}}],categories:categoriesData}}),colors=["#392351","#392351"];chart.setChartColors(colors)},showNoDataBox:function(){this._myMask.hide(),this.add({xtype:"label",text:"There is no data. Check if there are iterations in scope and work items with PlanEstimate assigned for iterations"})},medianX:function(medianArr){return count=medianArr.length,median=0===count%2?(medianArr[medianArr.length/2-1]+medianArr[medianArr.length/2])/2:medianArr[Math.floor(medianArr.length/2)]},countWeekDays:function(dDate1,dDate2){for(var days=0,dateItr=dDate1;dDate2>dateItr;)dateItr.setHours(dateItr.getHours()+6),6!=dateItr.getDay()&&0!==dateItr.getDay()&&(days+=.25);return days}});

            Rally.launchApp('CustomApp', {
                name:"estimation-calibration",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
