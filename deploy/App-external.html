<!DOCTYPE html>
<html>
<head>
    <title>estimation-calibration</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.TimeboxScopedApp",scopeType:"release",filters:[],pagesize:2e3,estimateTimes:{},launch:function(){this.fetchWorkItems(this.getContext().getTimeboxScope())},onTimeboxScopeChange:function(newTimeboxScope){this.callParent(arguments),this.fetchWorkItems(newTimeboxScope)},fetchWorkItems:function(timeboxScope){this.removeAll(),this.filters=[],this.estimateTimes={},this.filters=[];var startDate=timeboxScope.record.raw.ReleaseStartDate,endDate=timeboxScope.record.raw.ReleaseDate,startDateFilter=Ext.create("Rally.data.wsapi.Filter",{property:"InProgressDate",operator:">=",value:startDate}),endDateFilter=Ext.create("Rally.data.wsapi.Filter",{property:"AcceptedDate",operator:"<=",value:endDate}),estimateFilter=Ext.create("Rally.data.wsapi.Filter",{property:"PlanEstimate",operator:"!=",value:"null"});this.filters.push(startDateFilter),this.filters.push(endDateFilter),this.filters.push(estimateFilter);var dataScope=this.getContext().getDataContext(),store=Ext.create("Rally.data.wsapi.Store",{model:"UserStory",fetch:["InProgressDate","AcceptedDate","PlanEstimate"],context:dataScope,pageSize:this.pagesize,limit:this.pagesize,sorters:[{property:"PlanEstimate",direction:"ASC"}]},this);store.addFilter(this.filters,!1),store.loadPage(1,{scope:this,callback:function(records,operation){operation.wasSuccessful()&&(_.each(records,function(record){if(null!==record.data.InProgressDate&&null!==record.data.AcceptedDate){var estimate=record.data.PlanEstimate,cycleTime=(record.data.AcceptedDate-record.data.InProgressDate)/864e5;_.contains(Object.keys(this.estimateTimes),""+estimate)||(this.estimateTimes[estimate]=[]),this.estimateTimes[estimate].push(cycleTime)}},this),this.prepareChart())}})},prepareChart:function(){if(Object.keys(this.estimateTimes).length>0){var categories=Object.keys(this.estimateTimes),series=[];_.each(this.estimateTimes,function(values){values=values.sort(function(a,b){return a-b});var Q1=0,Q2=0,Q3=0,q1Arr=[],q2Arr=[],q3Arr=[];1==values.length?q1Arr=q2Arr=q3Arr=values:(q1Arr=0===values.length%2?values.slice(0,values.length/2):values.slice(0,Math.floor(values.length/2)),q2Arr=values,q3Arr=0===values.length%2?values.slice(values.length/2,values.length):values.slice(Math.ceil(values.length/2),values.length)),Q1=this.medianX(q1Arr),Q2=this.medianX(q2Arr),Q3=this.medianX(q3Arr),series.push([values[0],Q1,Q2,Q3,values[values.length-1]])},this),this.makeChart(series,categories)}else this.showNoDataBox()},makeChart:function(seriesData,categoriesData){var chart=this.add({xtype:"rallychart",chartConfig:{chart:{type:"boxplot"},title:{text:"Cycle Time by Plan Estimate"},xAxis:{title:{text:"Plan Estimate (Points)"}},yAxis:{title:{text:"Cycle Time (Days)"},allowDecimals:!1,min:0},plotOptions:{column:{pointPadding:.2,borderWidth:0}}},chartData:{series:[{name:"Cycle Time (Days)",data:seriesData}],categories:categoriesData}})},showNoDataBox:function(){Ext.ComponentQuery.query("container[itemId=stats]")[0].update("There is no data. </br>Check if there are interations in scope and work items with PlanEstimate assigned for iterations")},medianX:function(medianArr){return count=medianArr.length,median=0===count%2?(medianArr[medianArr.length/2-1]+medianArr[medianArr.length/2])/2:medianArr[Math.floor(medianArr.length/2)]}});

            Rally.launchApp('CustomApp', {
                name:"estimation-calibration",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
