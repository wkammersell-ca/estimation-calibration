<!DOCTYPE html>
<html>
<head>
    <title>estimation-calibration</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                var app=null,scatterChart,boxPlotChart;Ext.define("CustomApp",{extend:"Rally.app.TimeboxScopedApp",scopeType:"release",pagesize:2e3,estimateTimes:{},OUTLIER_THRESHOLD:1.5,onScopeChange:function(scope){app=this,app.callParent(arguments),app.fetchWorkItems(scope)},fetchWorkItems:function(scope){for(app._myMask=new Ext.LoadMask(Ext.getBody(),{msg:"Calculating...Please wait."}),app._myMask.show();app.down("*");)app.down("*").destroy();app.filters=[],app.estimateTimes={};var filters=[],startDate=scope.record.raw.ReleaseStartDate,endDate=scope.record.raw.ReleaseDate,startDateFilter=Ext.create("Rally.data.wsapi.Filter",{property:"InProgressDate",operator:">=",value:startDate}),endDateFilter=Ext.create("Rally.data.wsapi.Filter",{property:"AcceptedDate",operator:"<=",value:endDate}),estimateFilter=Ext.create("Rally.data.wsapi.Filter",{property:"PlanEstimate",operator:"!=",value:"null"});filters.push(startDateFilter),filters.push(endDateFilter),filters.push(estimateFilter);var dataScope=app.getContext().getDataContext(),store=Ext.create("Rally.data.wsapi.Store",{model:"UserStory",fetch:["FormattedID","Name","InProgressDate","AcceptedDate","PlanEstimate"],context:dataScope,pageSize:app.pagesize,limit:app.pagesize,sorters:[{property:"PlanEstimate",direction:"ASC"}]},app);store.addFilter(filters,!1),store.loadPage(1,{scope:app,callback:function(records,operation){operation.wasSuccessful()&&(_.each(records,function(record){null!==record.data.InProgressDate&&null!==record.data.AcceptedDate&&(estimateEntry={},estimateEntry.estimate=record.data.PlanEstimate,estimateEntry.id=record.data.FormattedID,estimateEntry.name=record.data.Name,estimateEntry.cycleTime=app.countWeekDays(new Date(record.data.InProgressDate),new Date(record.data.AcceptedDate)),estimateEntry.cycleTime>.25&&(_.contains(Object.keys(app.estimateTimes),""+estimateEntry.estimate)||(app.estimateTimes[estimateEntry.estimate]=[]),app.estimateTimes[estimateEntry.estimate].push(estimateEntry)))},app),app.prepareScatterChart())}})},prepareScatterChart:function(){if(Object.keys(app.estimateTimes).length>0){var seriesData=[];seriesData.push({}),seriesData[0].data=[],_.each(app.estimateTimes,function(values){_.each(values,function(story){var point={};point.x=story.estimate,point.y=story.cycleTime,point.tooltip=story.id+" - "+story.name+"<br/>Cycle Time: "+story.cycleTime+"d",seriesData[0].data.push(point)},app)},app),app.drawScatterChart(seriesData)}else app.showNoDataBox()},drawScatterChart:function(seriesData){for(;app.down("*");)app.down("*").destroy();scatterChart=app.add({xtype:"rallychart",chartConfig:{chart:{type:"scatter",zoomType:"xy"},legend:{enabled:!1},xAxis:{title:{text:"Plan Estimate"},tickInterval:1,startOnTick:!0,endOnTick:!0,showLastLabel:!0},yAxis:{title:{text:"Cycle Time (workdays)"},tickInterval:1,min:0,gridLineWidth:0},title:{text:"Cycle Time by Estimate"},tooltip:{useHTML:!0,pointFormat:"{point.tooltip}",headerFormat:""}},chartData:{series:seriesData}});var colors=["#61257a"];scatterChart.setChartColors(colors),app.add({xtype:"label",html:"This graph shows your completed work's cycle time by estimate.*<br/>Click below to see how you can improve your estimates to be more consistent and predictable.<br/><br/>",style:{"font-size":"15px"}}),app.add({xtype:"rallybutton",text:"Calibrate Estimates",id:"calibrationbutton",handler:function(){app.onCalibrateButton()},style:{"background-color":"#61257a","border-color":"#61257a"}}),app.add({xtype:"label",html:'<a href="https://help.rallydev.com/sizing-and-estimates-overview">Learn about agile estimation</a>',style:{"font-size":"15px"}}),app.add({xtype:"label",html:"<br/><br/>* Only work items started in progress and accepted in this release are tracked. Work items with a cycle time of .25days or less are ignored.",style:{"font-size":"9px"}}),this._myMask.hide()},onCalibrateButton:function(){var categories=Object.keys(app.estimateTimes),boxplots=[],outliers=[];_.each(app.estimateTimes,function(values){values=values.sort(function(a,b){return a.cycleTime-b.cycleTime});var Q1=0,Q2=0,Q3=0,q1Arr=[],q2Arr=[],q3Arr=[];1==values.length?q1Arr=q2Arr=q3Arr=values:(q1Arr=0===values.length%2?values.slice(0,values.length/2):values.slice(0,Math.floor(values.length/2)),q2Arr=values,q3Arr=0===values.length%2?values.slice(values.length/2,values.length):values.slice(Math.ceil(values.length/2),values.length)),Q1=app.medianX(q1Arr),Q2=app.medianX(q2Arr),Q3=app.medianX(q3Arr);for(var interquartile_range=Q3-Q1,min_index=0;values[min_index].cycleTime<Q1-app.OUTLIER_THRESHOLD*interquartile_range;)outliers.push([boxplots.length,values[min_index].cycleTime]),min_index++;for(var max_index=values.length-1;values[max_index].cycleTime>Q3+app.OUTLIER_THRESHOLD*interquartile_range;)outliers.push([boxplots.length,values[max_index].cycleTime]),max_index--;var boxplotPoint={};boxplotPoint.x=boxplots.length,boxplotPoint.low=values[min_index].cycleTime,boxplotPoint.q1=Q1,boxplotPoint.median=Q2,boxplotPoint.q3=Q3,boxplotPoint.high=values[max_index].cycleTime,boxplotPoint.count=max_index-min_index+1,boxplotPoint.estimate=values[0].estimate,boxplots.push(boxplotPoint),values.unshift(boxplotPoint)},app),app.makeBoxPlot(boxplots,outliers,categories)},makeBoxPlot:function(boxplots,outliers,categoriesData){for(;app.down("*");)app.down("*").destroy();boxPlotChart=app.add({xtype:"rallychart",storeConfig:{},chartConfig:{chart:{type:"boxplot"},title:{text:"Cycle Time by Plan Estimate"},xAxis:{title:{text:"Plan Estimate (Points)"}},yAxis:{title:{text:"Cycle Time (workdays)"},allowDecimals:!1,min:0,gridLineWidth:0},plotOptions:{column:{pointPadding:.2,borderWidth:0}}},chartData:{series:[{name:"Cycle Time",data:boxplots,tooltip:{headerFormat:"<b>Estimate:</b> {point.x}<br/>",pointFormat:"<b>Maximum:</b> {point.high}<br/><b>Upper quartile:</b> {point.q3}<br/><b>Median:</b> {point.median}<br/><b>Lower quartile:</b> {point.q1}<br/><b>Minimum:</b> {point.low}<br/><b>Count:</b> {point.count}"}},{name:"Outliers",type:"scatter",data:outliers,tooltip:{pointFormat:"{point.y}"}}],categories:categoriesData}});var colors=["#61257a","#61257a"];boxPlotChart.setChartColors(colors),app.add({xtype:"label",html:"Your data, displayed as a box plot, will help us identify which work items could benefit most from further analysis<br/>First, let's identify which estimate is most consitent. We will use this to then form a basis for your other estimates.<br/><br/>",style:{"font-size":"15px"}}),app.add({xtype:"rallybutton",text:"Identify Anchor Estimate",handler:function(){app.onIdentifyAnchorButton()},style:{"background-color":"#61257a","border-color":"#61257a"}}),app.add({xtype:"label",html:'<a href="https://www.khanacademy.org/math/probability/data-distributions-a1/box--whisker-plots-a1/v/reading-box-and-whisker-plots">Learn how to read box plots</a>',style:{"font-size":"15px"}})},onIdentifyAnchorButton:function(){var bestScore=0,bestEstimate,bestX,bestMedianCycleTime;_.each(app.estimateTimes,function(values){boxplotSummary=values[0];var score=boxplotSummary.count/(boxplotSummary.q3-boxplotSummary.q1);1/0!=score&&score>bestScore&&(bestScore=score,bestX=boxplotSummary.x,bestEstimate=boxplotSummary.estimate,bestMedianCycleTime=boxplotSummary.median)});var chartData=boxPlotChart.getChartData(),chartConfig=boxPlotChart.getChartConfig();for(chartData.series[0].data[bestX].color="#d30606",boxPlotChart.refresh({chartData:chartData});app.down("label");)app.down("label").destroy();for(;app.down("button");)app.down("button").destroy();app.add({xtype:"label",html:"Work items with an estimate of "+bestEstimate+" had the best balance of a tight interquartile range and a large number of work items. Let's use this to set target relative cycle times for our estimates.<br/><br/>",style:{"font-size":"15px"}}),app.add({xtype:"rallybutton",text:"Project Target Cycle Times",handler:function(){app.onProjectCycleTimesButton(bestEstimate,bestMedianCycleTime)},style:{"background-color":"#61257a","border-color":"#61257a"}})},onProjectCycleTimesButton:function(bestEstimate,bestMedianCycleTime){var chartData=boxPlotChart.getChartData(),estimateTargets={};for(_.each(chartData.series[0].data.reverse(),function(boxplot){var diff=boxplot.estimate/bestEstimate,target=bestMedianCycleTime*diff;estimateTargets[boxplot.estimate]=target;var newSeries={};newSeries.type="spline",newSeries.name="Target Cycle Time for "+boxplot.estimate+"s",newSeries.data=Array.apply(null,Array(chartData.series[0].data.length)).map(Number.prototype.valueOf,target),newSeries.lineWidth=2,newSeries.marker={},newSeries.marker.enabled=!1,newSeries.color="#ad3408",chartData.series.unshift(newSeries)}),boxPlotChart.refresh({chartData:chartData});app.down("label");)app.down("label").destroy();for(;app.down("button");)app.down("button").destroy();app.add({xtype:"label",html:"Taking these target cycle times, let's apply them back to our individual work item cycle times to see if there are ways to better estimate your work.<br/><br/>",style:{"font-size":"15px"}}),app.add({xtype:"rallybutton",text:"Identify Opportunities for Improvement",handler:function(){app.onIdentifyImprovements(estimateTargets)},style:{"background-color":"#61257a","border-color":"#61257a"}})},onIdentifyImprovements:function(estimateTargets){for(console.log(estimateTargets);app.down("*");)app.down("*").destroy();var estimateLookup={};_.each(_.keys(estimateTargets),function(estimate){var diff;if(_.isEmpty(estimateLookup)){var nextEstimate=_.keys[_.keys(estimateTargets).indexOf(estimate)+1];diff=(estimateTargets[nextEstimate]-estimateTargets[estimate])*(1-nextEstimate/estimate)}else{var priorEstimate=_.keys[_.keys(estimateTargets).indexOf(estimate)-1];diff=(estimateTargets[priorEstimate]-estimateTargets[estimate])*(priorEstimate/estimate)}estimateLookup[minTarget]=estimate}),console.log(estimateLookup)},showNoDataBox:function(){app._myMask.hide(),app.add({xtype:"label",text:"There is no data. Check if there are iterations in scope and work items with PlanEstimate assigned for iterations"})},medianX:function(medianArr){return count=medianArr.length,median=0===count%2?(medianArr[medianArr.length/2-1].cycleTime+medianArr[medianArr.length/2].cycleTime)/2:medianArr[Math.floor(medianArr.length/2)].cycleTime},countWeekDays:function(dDate1,dDate2){for(var days=0,dateItr=dDate1;dDate2>dateItr;)dateItr.setHours(dateItr.getHours()+6),6!=dateItr.getDay()&&0!==dateItr.getDay()&&(days+=.25);return days}});

            Rally.launchApp('CustomApp', {
                name:"estimation-calibration",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
